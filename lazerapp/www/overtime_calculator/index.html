{% extends "templates/web.html" %}

{% block title %}Overtime Calculator{% endblock %}

{% block page_content %}
<style>
.card-header{background: #DE2326!important; }
.card-header h3{ margin-top: 0; color: #ffffff!important; }
</style>
<div class="container mt-5">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3>Monthly Overtime Calculator</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Month</label>
                        <select id="month" class="form-control">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="year" class="form-control" value="2026">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="employee" class="form-control" placeholder="Employee ID">
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-primary" onclick="calculateOT()">
                        <i class="fa fa-calculator"></i> Calculate Overtime
                    </button>
                    <button class="btn btn-success ml-2" onclick="createAdditionalSalary()">
                        <i class="fa fa-money"></i> Create Additional Salary
                    </button>
                    <button class="btn btn-info ml-2" onclick="bulkCalculate()">
                        <i class="fa fa-users"></i> Bulk Calculate
                    </button>
                </div>
            </div>
            
            <div id="results" class="mt-4"></div>
        </div>
    </div>
</div>

<script>
function calculateOT() {
    const employee = document.getElementById('employee').value;
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    
    if (!employee) {
        frappe.msgprint('Please enter Employee ID');
        return;
    }
    
    frappe.call({
        method: 'lazerapp.overtime_calculator.calculate_monthly_overtime',
        args: {
            employee: employee,
            month: month,
            year: year
        },
        callback: function(r) {
            if (r.message) {
                displayResults(r.message);
            }
        }
    });
}

function displayResults(data) {
    let html = `
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h4>Overtime Calculation Results</h4>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <tr><th>Category</th><td>${data.category}</td></tr>
                    <tr><th>Total Working Hours</th><td>${data.total_working_hours.toFixed(2)}</td></tr>
                    <tr><th>Mandatory Hours</th><td>${data.mandatory_hours.toFixed(2)}</td></tr>
                    <tr><th>Extra Hours</th><td>${(data.extra_hours || data.extra_normal_hours || 0).toFixed(2)}</td></tr>
    `;
    
    if (data.public_holiday_hours) {
        html += `<tr><th>Public Holiday Hours</th><td>${data.public_holiday_hours.toFixed(2)}</td></tr>`;
    }
    
    html += `
                    <tr class="table-success"><th><strong>Overtime Amount</strong></th><td><strong>${data.overtime_amount.toFixed(3)} BHD</strong></td></tr>
                </table>
                
                <h5 class="mt-3">Calculation Breakdown:</h5>
                <div class="alert alert-light">
    `;
    
    if (data.calculation_breakdown) {
        for (let key in data.calculation_breakdown) {
            html += `<p><strong>${key}:</strong> ${data.calculation_breakdown[key]}</p>`;
        }
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('results').innerHTML = html;
}

function createAdditionalSalary() {
    const employee = document.getElementById('employee').value;
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    
    if (!employee) {
        frappe.msgprint('Please enter Employee ID');
        return;
    }
    
    frappe.call({
        method: 'lazerapp.overtime_calculator.create_additional_salary_for_overtime',
        args: {
            employee: employee,
            month: month,
            year: year
        },
        callback: function(r) {
            if (r.message) {
                frappe.msgprint('Additional Salary Entry Created Successfully');
            }
        }
    });
}

function bulkCalculate() {
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    
    frappe.call({
        method: 'lazerapp.overtime_calculator.bulk_calculate_overtime',
        args: {
            month: month,
            year: year
        },
        callback: function(r) {
            if (r.message) {
                displayBulkResults(r.message);
            }
        }
    });
}

function displayBulkResults(data) {
    let total = 0;
    let html = `
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h4>Bulk Overtime Calculation Results</h4>
            </div>
            <div class="card-body">
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th>Employee</th>
                            <th>Category</th>
                            <th>Total Hours</th>
                            <th>Extra Hours</th>
                            <th>OT Amount (BHD)</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    data.forEach(row => {
        total += row.overtime_amount;
        html += `
            <tr>
                <td>${row.employee_name}</td>
                <td>${row.category}</td>
                <td>${row.total_hours.toFixed(2)}</td>
                <td>${row.extra_hours.toFixed(2)}</td>
                <td>${row.overtime_amount.toFixed(3)}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                    <tfoot>
                        <tr class="table-success">
                            <td colspan="4"><strong>Total Overtime Amount</strong></td>
                            <td><strong>${total.toFixed(3)} BHD</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('results').innerHTML = html;
}

// Set current month and year on page load
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    document.getElementById('month').value = now.getMonth() + 1;
    document.getElementById('year').value = now.getFullYear();
});
</script>

<style>
.card {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.table th {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
